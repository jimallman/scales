let scene,camera,renderer,masterGroup,keyboardGroup,carouselRadius,dataLength,categorySet,noteRadius,raycaster,audioCtx,width=window.innerWidth,height=window.innerHeight,highlights=[],activeHighlight=null,panels=[],activePanel=null,mouse=new THREE.Vector2,pitchshift=0,scaleshift=0,noteLabelType="flat",noteLabels={sharp:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],flat:["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],elements:[]},pageElements={name:null,category:null,description:null},green="#00e19e",gold="#ffd830",grey="#666666",tweens=new Set([]),carouselRot={amount:0},flagUpdate=!0,audioBuffers=[];init(),loadAudio(),loadData("./scales.json",a=>{visualize(a).then(()=>{console.log(scene)})}),initDocument();function initDocument(){window.addEventListener("resize",resize,!1),window.addEventListener("mousemove",onMouseMove,!1),window.addEventListener("mousedown",onMouseDown),document.onkeydown=a=>{a=a||window.event,"37"==a.keyCode?rotateCarousel("left"):"39"==a.keyCode&&rotateCarousel("right")},document.getElementById("flat").onclick=()=>{"flat"!=noteLabelType&&(noteLabelType="flat",createLabels(carouselRadius,pitchshift))},document.getElementById("sharp").onclick=()=>{"sharp"!=noteLabelType&&(noteLabelType="sharp",createLabels(carouselRadius,pitchshift))},document.getElementById("increase-root").onclick=()=>{changePitch(1)},document.getElementById("decrease-root").onclick=()=>{changePitch(-1)},document.getElementById("name").style.color=green}function init(){scene=new THREE.Scene,scene.background=new THREE.Color(2041391);const a=window.devicePixelRatio?window.devicePixelRatio:1;renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),renderer.setPixelRatio(a),renderer.setSize(width,height),document.getElementById("canvas").appendChild(renderer.domElement),clock=new THREE.Clock,carouselRadius=70;let b=width/height;camera=new THREE.PerspectiveCamera(60,b,1,carouselRadius/2),camera.position.set(0,0,1.2*carouselRadius),camera.updateMatrixWorld(),raycaster=new THREE.Raycaster,AudioContext=window.AudioContext||window.webkitAudioContext,audioCtx=new AudioContext,masterGroup=new THREE.Group}function loadData(a,b){$.getJSON(a,a=>{dataLength=a.length,scene.userData.data=a,b(a)})}function loadAudio(){for(let a=0;23>a;a++){let b=`./audio/marimba/${a+1}.mp3`,c=new XMLHttpRequest;c.open("GET",b,!0),c.responseType="arraybuffer",c.onload=()=>{audioCtx.decodeAudioData(c.response,function(b){audioBuffers[a]=b},a=>{console.error(a)})},c.send()}}function animate(a){window.requestAnimationFrame(animate),render(a)}function render(a){tweens.forEach(b=>{b.update(a)}),masterGroup.rotation.y=carouselRot.amount,raycaster.setFromCamera(mouse,camera);let b=raycaster.intersectObjects(highlights);if(0<b.length){let a=b[0].object;activeHighlight!=a&&(activeHighlight=a,playNote(a,pitchshift)),activeHighlight=a}else activeHighlight&&(activeHighlight.material.opacity=0,activeHighlight=null);let c=raycaster.intersectObjects(panels);if(0<c.length){let a=c[0].object;activePanel!=a&&(activePanel=a),activePanel=a,a.material.opacity=.1}else activePanel&&(activePanel.material.opacity=0,activePanel=null);renderer.render(scene,camera)}function visualize(a){return new Promise((b,c)=>{try{let c=.7,d=4;noteRadius=d,createLabels(d,pitchshift);let e=[];for(let b=0;b<a.length;b++){let f=new THREE.Group,g=[],h=a[b].intervals;for(let a=0;a<h.length;a++){0==a&&g.push(!0);for(let b=0;b<h[a]-1;b++)g.push(!1);g.push(!0)}g.pop(),createRings(g,f,c,d,.05),createPaths(h,f,c,d);let i=new THREE.Spherical(carouselRadius,-Math.PI/2,Math.PI+b*(2*Math.PI/a.length)),j=new THREE.Vector3().setFromSpherical(i);f.rotateY(2*Math.PI*(b/a.length)),f.position.copy(j),f.userData.notes=g,f.userData.index=b,f.userData.name=a[b].name,f.userData.category=a[b].category,e.push(a[b].category),masterGroup.add(f)}createPanels(d),updateLabels(masterGroup.children[scaleshift].userData.notes,!1),displayKeyboard(),categorySet=new Set(e),scene.add(masterGroup),b()}catch(a){c(a)}})}function createRings(a,b,c,d,e){for(let f=0;f<a.length;f++){let g=new THREE.RingBufferGeometry(c*(1-e),c,64),h=new THREE.MeshBasicMaterial({color:new THREE.Color(grey),transparent:!0,opacity:1,wireframe:!1}),i=new THREE.Mesh(g,h);if(i.rotateZ(getRotation(f)),i.translateY(d),a[f]){h.color=0==f?new THREE.Color(gold):new THREE.Color(green);let a=new THREE.CircleBufferGeometry(c*(1-e),64),d=new THREE.MeshBasicMaterial({color:new THREE.Color(16777215),transparent:!0,opacity:0,wireframe:!1});highlight=new THREE.Mesh(a,d),highlight.position.copy(i.position),highlight.userData.note=f,highlight.userData.ring=i,visHighlight=highlight.clone(),visHighlight.material=d.clone(),visHighlight.material.opacity=.05;let g=new THREE.Group;g.add(i,visHighlight),highlights.push(highlight),b.add(highlight),b.add(g)}else b.add(i)}}function changePitch(a){if(0>pitchshift+a?0:11<pitchshift+a?11:pitchshift+=a,1>=pitchshift||10<=pitchshift)switch(pitchshift){case 0:document.getElementById("decrease-root").style.color="#ffffff";break;case 1:document.getElementById("decrease-root").style.color="#ff4c7a";break;case 11:document.getElementById("increase-root").style.color="#ffffff";break;case 10:document.getElementById("increase-root").style.color="#ff4c7a";break;default:}createLabels(carouselRadius,pitchshift),displayKeyboard()}function createLabels(a,b){for(let c=0+b;c<12+b;c++)if(12!=noteLabels.elements.length){let d=new THREE.Mesh;d.rotateZ(getRotation(c-b)),d.translateY(a),d.translateZ(carouselRadius);let e=screenPosition(d,camera),f=document.createElement("div");f.innerHTML=noteLabels[noteLabelType][c%12],f.style.position="absolute",f.classList.add("note"),document.body.appendChild(f),f.style.left=e.x-f.clientWidth/2+"px",f.style.top=e.y-f.clientHeight/2+"px",noteLabels.elements.push(f)}else{let a=noteLabels.elements[c-b],d={width:a.clientWidth,height:a.clientHeight,left:parseFloat(a.style.left.slice(0,-2)),top:parseFloat(a.style.top.slice(0,-2))};a.innerHTML=noteLabels[noteLabelType][c%12],a.style.left=d.left+(d.width-a.clientWidth)/2+"px",a.style.top=d.top+(d.height-a.clientHeight)/2+"px"}"sharp"==noteLabelType?(document.getElementById("sharp").style.textDecoration="underline",document.getElementById("flat").style.textDecoration="none"):"flat"==noteLabelType&&(document.getElementById("flat").style.textDecoration="underline",document.getElementById("sharp").style.textDecoration="none")}function updateLabels(a,b){let c=b?300:0;window.setTimeout(()=>{let b=masterGroup.children[scaleshift].userData,c=b.notes.filter(a=>!0==a).length;document.getElementById("name").innerText=b.name+` (${c})`,document.getElementById("category").innerText=b.category,document.getElementById("category").style.color="#ff4c7a";for(let b=0;b<noteLabels.elements.length;b++)noteLabels.elements[b].style.color=a[b]?"#FFFFFF":"#444444";let d=Array.from(document.getElementsByClassName("interval-label"));for(let a=0;a<d.length;a++)d[a].remove();for(let a=0;a<b.intervals.length;a++){let c=screenPosition(b.intervals[a].mesh,camera),d=document.createElement("div");d.classList.add(`interval-label`),d.style.position="absolute",d.innerText=b.intervals[a].interval,document.body.appendChild(d),d.style.left=c.x-d.clientWidth/2+"px",d.style.top=c.y-d.clientHeight/2+"px"}},c)}function updateLabelPositions(){for(let a,b=0;12>b;b++){a=new THREE.Mesh,a.rotateZ(getRotation(b)),a.translateY(noteRadius),a.translateZ(carouselRadius);let c=screenPosition(a,camera);noteLabel=noteLabels.elements[b],noteLabel.style.left=c.x-noteLabel.clientWidth/2+"px",noteLabel.style.top=c.y-noteLabel.clientHeight/2+"px"}let a=masterGroup.children[scaleshift].userData.intervals,b=Array.from(document.getElementsByClassName("interval-label"));for(let c=0;c<a.length;c++){let d=a[c].mesh,e=b[c],f=screenPosition(d,camera);e.style.left=f.x-e.clientWidth/2+"px",e.style.top=f.y-e.clientHeight/2+"px"}}function createPaths(a,b,d,e){let f=0;b.userData.intervals=[];for(let g=0;g<a.length;g++){let h=f,i=f+a[g],j=e-d,k=j-a[g]*e/3.5,l=new THREE.Spherical(j,getRotation(h),-Math.PI/2),m=new THREE.Spherical(k,(getRotation(h)+getRotation(i))/2,-Math.PI/2),n=new THREE.Spherical(j,getRotation(i),-Math.PI/2),o=new THREE.Spherical(j-.85*a[g],(getRotation(h)+getRotation(i))/2,-Math.PI/2),p=new THREE.Vector3().setFromSpherical(l),q=new THREE.Vector3().setFromSpherical(m),r=new THREE.Vector3().setFromSpherical(n),s=new THREE.Vector3().setFromSpherical(o),t=createCurve(new THREE.Vector2(p.x,p.y),new THREE.Vector2(q.x,q.y),new THREE.Vector2(r.x,r.y)),c=new THREE.Mesh;c.position.copy(s),c.translateZ(carouselRadius),b.userData.intervals.push({mesh:c,interval:a[g]}),b.add(t),f+=a[g]}}function createPanels(a){let b=4.5*a,c=new THREE.PlaneBufferGeometry(b,3*a),d=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:0}),e=new THREE.Mesh(c,d);e.position.copy(camera.position.clone().multiplyScalar(.8)),e.updateMatrix();let f=e.clone(),g=e.clone();f.material=d.clone(),g.material=d.clone();let h=.1;f.scale.set(h,1,1),g.scale.set(h,1,1),f.translateX(b/2-b*h/2),g.translateX(-b/2+b*h/2),f.userData.direction="right",g.userData.direction="left",panels.push(f),panels.push(g),scene.add(f),scene.add(g);let i=new THREE.BufferGeometry,j=new Float32Array(9);j.set([0,-1,0,1,0,0,0,1,0]),i.addAttribute("position",new THREE.BufferAttribute(j,3)),i.computeVertexNormals(),aMat=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.5,side:THREE.DoubleSide}),aMesh=new THREE.Mesh(i,aMat),aMesh.position.copy(camera.position.clone().multiplyScalar(.8));let k=aMesh.clone(),l=aMesh.clone();k.translateX(b/2-.5-b*h/2),l.rotateY(Math.PI),l.translateX(b/2-.5-b*h/2),scene.add(k),scene.add(l)}function createCurve(a,b,c){let d=new THREE.QuadraticBezierCurve(a,b,c).getPoints(30),e=new THREE.BufferGeometry,f=[],g=new Float32Array(93);for(let e=0;e<=30;e++)f.push(d[e].x),f.push(d[e].y),f.push(0);g.set(f),e.addAttribute("position",new THREE.BufferAttribute(g,3));let h=new THREE.Line(e,new THREE.LineBasicMaterial({color:6710886,linewidth:1}));return h}function rotateCarousel(a){"left"==a?scaleshift=0>scaleshift-1?dataLength-1:scaleshift-1:"right"==a&&(scaleshift=scaleshift+1==dataLength?0:scaleshift+1);let b=new TWEEN.Tween(carouselRot);b.to({amount:2*(-scaleshift*Math.PI)/dataLength},300).easing(TWEEN.Easing.Cubic.In).onStart(()=>{flagUpdate=!0}).onComplete(()=>{flagUpdate=!1,tweens.delete(b)}).start(),tweens.add(b),updateLabels(masterGroup.children[scaleshift].userData.notes,!0),displayKeyboard()}function getRotation(a){return 2*(-a*Math.PI)/12}function screenPosition(a,b){let c=a.position.clone();c.project(b);let d=new THREE.Vector3;return d.x=width/2*(1+c.x),d.y=height/2*(1-c.y),d.z=0,d}function playNote(a,b){if(!flagUpdate){let c=a.userData.note,d=audioCtx.createBufferSource();d.buffer=audioBuffers[c+b],d.connect(audioCtx.destination),d.start(0);let e=a.userData.ring,f=.5<=Math.random()?1:-1,g=.5<=Math.random()?1:-1,h=new TWEEN.Tween(e.rotation);h.to({x:2*(f*Math.PI),y:2*(g*Math.PI)},350).easing(TWEEN.Easing.Exponential.Out).onComplete(a=>{a.x=0,a.y=0,tweens.delete(h)}).start(),tweens.add(h),playKeyboardNote(c)}}function resize(){width=window.innerWidth,height=window.innerHeight,renderer.setSize(width,height),camera.aspect=width/height,camera.updateProjectionMatrix(),updateLabelPositions()}function onMouseMove(a){a.preventDefault(),mouse.x=2*(a.clientX/width)-1,mouse.y=2*-(a.clientY/height)+1}function onMouseDown(a){a.preventDefault(),null!=activePanel&&(rotateCarousel(activePanel.userData.direction),activePanel=null)}initKeyboard();function initKeyboard(){keyboardGroup=new THREE.Group;let a=[0,2,4,5,7,9,11,12,14,16,17,19,21,23],b=.5,c=b/7;for(let d,e=0;14>e;e++){d=new THREE.Group,d.userData.index=a.shift();let f=new THREE.BoxBufferGeometry(b,3*b,.01),g=new THREE.BoxBufferGeometry(b-c,3*b-c,.01),h=new THREE.Mesh(f,new THREE.MeshBasicMaterial({color:6710886}));h.translateZ(-1e-7);let i=new THREE.Mesh(g,new THREE.MeshBasicMaterial({color:2041391}));d.add(i,h),d.translateX((b-c)*e),d.translateZ(carouselRadius),d.translateY(-6),keyboardGroup.add(d)}let d=.3,e=[1,3,6,8,10,13,15,18,20,22],f=d/7;for(let a=0;13>a;a++)if(2!=a&&6!=a&&9!=a){let g=new THREE.Group;g.userData.index=e.shift();let h=new THREE.BoxBufferGeometry(d,3*d,.01),i=new THREE.BoxBufferGeometry(d-f,3*d-f,.01),j=new THREE.Mesh(h,new THREE.MeshBasicMaterial({color:6710886}));j.translateZ(-1e-7);let k=new THREE.Mesh(i,new THREE.MeshBasicMaterial({color:2041391}));g.add(k,j),g.translateX(b/2-c+(b-c)*a),g.translateZ(carouselRadius+1e-5),g.translateY(-6+3*(b-d)/2),keyboardGroup.add(g)}keyboardGroup.children.sort((c,a)=>c.userData.index-a.userData.index),keyboardGroup.translateX(-6.5*(b-c)),scene.add(keyboardGroup)}function displayKeyboard(){let a=masterGroup.children[scaleshift].userData.notes,b=keyboardGroup.children,c=!0;for(let d=0;d<b.length;d++)d<pitchshift||d>=pitchshift+12||!1==a[d-pitchshift]?b[d].children[0].material.color=new THREE.Color(2041391):(b[d].children[0].material.color=c?new THREE.Color(16767024):new THREE.Color(57758),c=!1)}function playKeyboardNote(a){let b,c=keyboardGroup.children,d=c[a+pitchshift].children[0];b=0===a?new THREE.Color(16767024):new THREE.Color(57758),d.material.color=new THREE.Color(16777215);let e=new TWEEN.Tween(d.material.color);e.to({r:b.r,g:b.g,b:b.b},1800).easing(TWEEN.Easing.Exponential.Out).onComplete(()=>{tweens.delete(e)}).start(),tweens.add(e)}if(WEBGL.isWebGLAvailable())document.getElementById("ready-btn").onclick=()=>{audioCtx.resume(),animate(),flagUpdate=!1,document.getElementById("overlay").style.display="none"};else{var warning=WEBGL.getWebGLErrorMessage();document.getElementById("overlay-content").appendChild(warning)}